# 批注插件 (Annotation Plugin)

Trilium Notes 的文本批注功能插件，支持固定工具栏和浮动工具栏两种模式。

![版本](https://img.shields.io/badge/version-3.5-blue)

## ✨ 功能特性

- 📝 **选中文字添加批注**：选择任意文字，点击批注按钮即可添加注释
- ✏️ **批注编辑与删除**：点击已有批注可以修改或删除
- 📱 **多行输入支持**：批注支持多行文本，可自由调整输入框大小
- 🎨 **视觉高亮显示**：批注文字带有黄色背景高亮，易于识别
- 🔧 **双模式支持**：同时支持固定工具栏和浮动工具栏（Balloon Toolbar）
- 💾 **内容持久化**：批注内容编码到链接中，随笔记一起保存

## 📦 安装

1. **在 Trilium 中创建新笔记**
   - 笔记类型：**Code (JavaScript)**
   - 标题：批注插件（或任意名称）

2. **复制插件代码**
   - 将 `trilium-annotation-plugin.js` 的内容复制到笔记中

3. **设置启动标签**
   - 为笔记添加标签：`#run=frontendStartup`

4. **刷新应用**
   - 按 `F5` 刷新页面

5. **验证安装**
   - 打开浏览器控制台（F12）
   - 应看到初始化日志：
     ```
     [批注插件] v3.5 初始化
     [批注插件] 从 bold 按钮获取了 ButtonView 类
     [批注插件] 已为编辑器注册批注功能
     [批注插件] ✓ 批注按钮已添加到浮动工具栏
     [批注插件] v3.5 初始化完成 - 支持浮动工具栏
     ```

## 🚀 使用方法

### 添加批注

1. **选中文字** - 在文本笔记中选择要添加批注的文字
2. **点击批注按钮** - 工具栏中的 📝 图标
   - 固定工具栏：顶部工具栏
   - 浮动工具栏：选中文字后弹出的工具栏
3. **输入批注内容**
   - 支持多行输入
   - 快捷键：`Ctrl + Enter` 确认，`Esc` 取消
4. **完成** - 批注文字显示黄色背景高亮

### 编辑/删除批注

1. **点击批注文字** - 鼠标悬停时光标变为 ❓
2. **修改内容** - 编辑后点击"确定"保存
3. **删除批注** - 清空内容后点击"确定"

## 🎨 批注样式

- 黄色背景（`#fff3cd`）
- 金色底部边框（`#ffc107`）
- 鼠标悬停时加深
- 圆角边框

## ⚙️ 技术细节

### 数据存储

批注内容编码到链接 URL 的查询参数中：

```
#annotation-1234567890?text=%E6%89%B9%E6%B3%A8%E5%86%85%E5%AE%B9
```

### 实现原理

1. **按钮注册**：通过 CKEditor 的 `componentFactory` API 注册按钮
2. **工具栏集成**：动态添加到 BalloonToolbar 的 items 集合
3. **事件监听**：使用 MutationObserver 监听编辑器创建和内容变化
4. **降级策略**：如果 API 方式失败，自动降级到 DOM 注入

### 兼容性

- **Trilium**: v0.100.0+
- **编辑器**: CKEditor 5
- **浏览器**: 现代浏览器

## 🐛 故障排除

### 浮动工具栏中没有批注按钮

1. 检查控制台是否有错误
2. 确认看到日志：`[批注插件] ✓ 批注按钮已添加到浮动工具栏`
3. 刷新页面（F5）
4. 插件会自动降级到 DOM 注入模式

### 点击按钮没有反应

1. 确保已选中文字
2. 检查控制台错误
3. 刷新页面重试

### 批注内容丢失

批注内容存储在链接 URL 中，不要手动修改批注链接。

### 插件未加载

检查：
- ✅ 笔记类型是 **Code (JavaScript)**
- ✅ 已添加标签 `#run=frontendStartup`
- ✅ 已刷新页面
- ✅ 控制台无错误

### 调试工具

在控制台运行：

```javascript
const editor = document.querySelector('.ck-editor__editable')?.ckeditorInstance;

console.log('=== 批注插件调试 ===');
console.log('编辑器:', editor);
console.log('插件实例:', window.triliumAnnotationPlugin);
console.log('已注册按钮:', editor?.ui?.componentFactory?.has('annotation'));
console.log('BalloonToolbar:', editor?.plugins?.get('BalloonToolbar'));
```

## 📝 版本历史

### v3.5 (2025-12-24) - 当前版本
- ✅ 修复浮动工具栏按钮显示问题
- ✅ 从现有按钮获取 ButtonView 类
- ✅ 改进错误处理和降级策略

### v3.4 (2025-12-24)
- ✅ 直接修改 BalloonToolbar 配置
- ✅ 增强浮动工具栏支持

### v3.3 (2025-12-24)
- ✅ 通过 CKEditor API 注册按钮
- ✅ 支持浮动工具栏

### v3.2
- ✅ 支持多行文本输入

### v3.1
- ✅ 批注内容编码到 URL

### v3.0
- ✅ 初始版本

## 💡 使用技巧

1. **快速编辑**: 使用 `Ctrl + Enter` 快捷键快速确认
2. **批量删除**: 选择批注文字，清空内容后确认
3. **样式统一**: 所有批注使用统一的黄色高亮
4. **持久保存**: 批注随笔记自动保存和同步

## 🤝 反馈

如有问题或建议：
- 查看主仓库 README
- 提交 Issue
- 查看控制台错误信息

---

**返回**: [插件列表](../README.md)

**最后更新**: 2025-12-24
